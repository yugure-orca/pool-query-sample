import { Connection, PublicKey, Keypair } from "@solana/web3.js";
import {
    WhirlpoolContext, ORCA_WHIRLPOOL_PROGRAM_ID, buildWhirlpoolClient,
} from "@orca-so/whirlpools-sdk";
import { Wallet } from "@coral-xyz/anchor";
import fetch from "node-fetch";
import Decimal from "decimal.js";
import * as prompt from "prompt";

import { getLiquidityDistribution } from "./liquidity_distribution";

const V1_WHIRLPOOL_LIST_ENDPOINT = "https://api.mainnet.orca.so/v1/whirlpool/list";

async function main() {
  // fetch the list of pools
  const response = await (await fetch(V1_WHIRLPOOL_LIST_ENDPOINT)).json();
  const list = [];
  response.whirlpools.forEach((p) => {
    list.push({
      address: new PublicKey(p.address),
      name: `${p.tokenA.symbol}/${p.tokenB.symbol}(${p.tickSpacing})`,
      symbolA: p.tokenA.symbol,
      symbolB: p.tokenB.symbol,
      decimalsA: p.tokenA.decimals,
      decimalsB: p.tokenB.decimals,
      mintA: new PublicKey(p.tokenA.mint),
      mintB: new PublicKey(p.tokenB.mint),
      tickSpacing: p.tickSpacing,
      price: new Decimal(p.price),
      usdTVL: new Decimal(p.tvl ?? 0),
      usdVolumeDay: new Decimal(p.volume?.day ?? 0),
    });
  });
  list.sort((a, b) => a.name.localeCompare(b.name));

  // list pools
  list.forEach((p) => { console.log(`${p.name}: ${p.address.toBase58()}`); });

  // prompt (get target pool)
  const input = await prompt.get([
    "rpcServerEndpoint",
    "whirlpoolAddress",
  ]);

  // build RPC client
  console.log("rpcServerEndpoint:", input.rpcServerEndpoint);
  const connection = new Connection(input.rpcServerEndpoint, "confirmed");
  const ctx = WhirlpoolContext.from(connection, new Wallet(Keypair.generate()), ORCA_WHIRLPOOL_PROGRAM_ID);
  const client = buildWhirlpoolClient(ctx);

  // get pool
  console.log("whirlpoolAddress:", input.whirlpoolAddress);
  const whirlpoolPubkey = new PublicKey(input.whirlpoolAddress);

  // get liquidity distribution
  const liquidityDistribution = await getLiquidityDistribution(client, whirlpoolPubkey);

  // print liquidity distribution
  console.log("liquidity distribution:");
  console.log("currentTickIndex:", liquidityDistribution.currentTickIndex);
  console.log("currentPrice:", liquidityDistribution.currentPrice.toFixed(9));
  console.log("currentLiquidity:", liquidityDistribution.currentLiquidity.toString());
  console.log("datapoints:");
  liquidityDistribution.datapoints.forEach((p) => {
    console.log(`  ${p.tickIndex}: ${p.price.toFixed(9)}: ${p.liquidity.toString()}`);
  });
}

main();

/*

Sample output:

ZERO/USDC(128): FF38D19wyMxnjnJ7RMUwN4XhMgv3NHKarbNZNtBA9ro1
ZERO/USDC(256): HCHp3X4RzKEi1ZwD9FeE9bfwe2pnyorU2mFNBtNvAowe
ZERO/USDC(64): G516tV5Pn4JVDzdUC76gtbtCSgdKW2UuYHxvdEPVKCB8
ZERO/USDT(128): 7r1JMr6pSES5Xpdrtac1ZQ4Ue76jvKsqzT3udNtQXnyo

prompt: rpcServerEndpoint:  https://rpc.helius.xyz/?api-key=xxxxxxxxxxxxxxxxxxx
prompt: whirlpoolAddress:  HJPjoWUrhoZzkNfRpHuieeFk9WcZWjwy6PBjZ81ngndJ

rpcServerEndpoint: https://rpc.helius.xyz/?api-key=xxxxxxxxxxxxxxxxxxx
whirlpoolAddress: HJPjoWUrhoZzkNfRpHuieeFk9WcZWjwy6PBjZ81ngndJ

liquidity distribution:
currentTickIndex: -25699
currentPrice: 76.557548825
currentLiquidity: 3483182815671
datapoints:
  -443584: 0.000000000: 465642019029
  -138112: 0.001005013: 465643559037
  -94592: 0.078005823: 465645452807
  -58048: 3.013931882: 465676757428
  -52928: 5.028993684: 468346076002
  -49792: 6.881276843: 483408855733
  -48640: 7.721421373: 483409072634
  -48256: 8.023674972: 485364925545
  -48000: 8.231722293: 486539831697
  -47488: 8.664140301: 486566234098
  -47360: 8.775748485: 490484389169
  -47104: 9.003296457: 490615321361
  -46976: 9.119273522: 499882682045
  -46848: 9.236744561: 502163612578
  -46016: 10.038074807: 1294190726742
  -45952: 10.102521272: 1294164324341
  -45696: 10.364471376: 1294164593364
  -45568: 10.497982583: 1296726143629
  -45504: 10.565381749: 1331060621166
  -45440: 10.633213631: 1331405177990
  -44736: 11.408731052: 1331737005716
  -44672: 11.481977407: 1333891068450
  -44480: 11.704550106: 1347183973387
  -44416: 11.779695678: 1347343990583
  -44224: 12.008039505: 1349876645980
  -44096: 12.162722536: 1351272583059
  -43776: 12.558203839: 1359987228128
  -43584: 12.801638678: 1359989475771
  -43072: 13.474117521: 1360157886638
  -42688: 14.001559338: 1357625231241
  -42432: 14.364608306: 1357625231360
  -42240: 14.643059440: 1355471168626
  -41984: 15.022741980: 1359522192512
  -41920: 15.119191014: 1351687257333
  -41856: 15.216259271: 1350354469235
  -41792: 15.313950725: 1350354467761
  -41664: 15.511219256: 1350194450565
  -41600: 15.610804413: 1350195033764
  -41472: 15.811896901: 1346276878693
  -41408: 15.913412469: 1346256955544
  -41344: 16.015579787: 1330472085521
  -41152: 16.326034223: 1330853966701
  -40960: 16.642506670: 1330854893752
  -40320: 17.742393086: 1330632255069
  -40064: 18.202438809: 1330634842165
  -39872: 18.555284472: 1330982166784
  -39808: 18.674413141: 1331245066502
  -39744: 18.794306641: 1331302693303
  -39680: 18.914969881: 1331971565629
  -39616: 19.036407803: 1342159530948
  -39552: 19.158625381: 1342175434622
  -39424: 19.405419560: 1341506562296
  -39360: 19.530006268: 1352152719453
  -39296: 19.655392848: 1352314131070
  -39168: 19.908586198: 1352104033184
  -39104: 20.036403337: 564967327038
  -39040: 20.165041089: 564805915421
  -38976: 20.294504720: 564830397914
  -38912: 20.424799535: 570144396294
  -38656: 20.954397860: 570159843330
  -38592: 21.088929322: 596574465099
  -38528: 21.224324502: 596574479872
  -38400: 21.497728237: 596759302111
  -38336: 21.635747989: 596761413466
  -38272: 21.774653856: 596795192099
  -38144: 22.055146726: 614755707634
  -38080: 22.196745217: 616186030733
  -38016: 22.339252799: 631331209259
  -37952: 22.482675308: 631354248710
  -37888: 22.627018619: 631474957595
  -37824: 22.772288643: 651587453319
  -37760: 22.918491330: 652248377635
  -37696: 23.065632667: 652975358764
  -37632: 23.213718682: 640849824629
  -37568: 23.362755439: 640825342136
  -37504: 23.512749042: 640881519787
  -37376: 23.815631398: 641115266066
  -37248: 24.122415370: 641101561349
  -37120: 24.433151217: 673027265841
  -37056: 24.590016977: 676643937783
  -36928: 24.906776291: 689027577886
  -36864: 25.066682819: 775847093094
  -36800: 25.227615980: 776701471524
  -36672: 25.552588604: 780008893811
  -36608: 25.716641377: 789375786415
  -36544: 25.881747403: 803100329941
  -36480: 26.047913442: 791873468255
  -36416: 26.215146301: 792889947245
  -36288: 26.552839918: 794571789914
  -36224: 26.723314507: 794189908734
  -36096: 27.067554155: 812635705306
  -36032: 27.241333313: 812664029174
  -35904: 27.592245883: 812698341388
  -35840: 27.769393668: 812743658422
  -35776: 27.947678777: 812972372090
  -35712: 28.127108513: 812353411560
  -35648: 28.307690224: 784753494522
  -35584: 28.489431305: 795824069231
  -35520: 28.672339201: 795832011261
  -35456: 28.856421403: 814353038872
  -35392: 29.041685450: 821994225335
  -35328: 29.228138929: 827628801869
  -35264: 29.415789477: 856544233095
  -35200: 29.604644779: 872902709790
  -35136: 29.794712571: 911906662647
  -35072: 29.986000636: 932252527012
  -35008: 30.178516809: 987664361229
  -34944: 30.372268975: 988083181627
  -34880: 30.567265068: 1419860372116
  -34816: 30.763513076: 1631743078526
  -34752: 30.961021036: 1619064401259
  -34688: 31.159797037: 1619179337683
  -34624: 31.359849220: 1619718031360
  -34560: 31.561185778: 1939872796332
  -34496: 31.763814957: 1937004631174
  -34432: 31.967745057: 1891048161809
  -34368: 32.172984429: 1961536122112
  -34304: 32.379541479: 1961914144745
  -34240: 32.587424667: 1963590813136
  -34176: 32.796642508: 1978963819833
  -34112: 33.007203568: 2017492705018
  -34048: 33.219116474: 2066081673022
  -33984: 33.432389903: 2052773050912
  -33920: 33.647032590: 2047561449413
  -33856: 33.863053327: 2047525705118
  -33792: 34.080460960: 2011276358589
  -33728: 34.299264395: 2011276356223
  -33664: 34.519472591: 2010836524831
  -33600: 34.741094569: 2018183285644
  -33536: 34.964139404: 2036348266832
  -33472: 35.188616232: 2396575477999
  -33408: 35.414534247: 2382623686954
  -33280: 35.870730906: 2382656977335
  -33216: 36.101028235: 2356242355566
  -33152: 36.332804119: 2327370251010
  -33088: 36.566068051: 2323929575580
  -33024: 36.800829584: 2304170066518
  -32960: 37.037098334: 2300212277988
  -32896: 37.274883976: 2300169992107
  -32832: 37.514196251: 1865324425217
  -32768: 37.755044958: 1860488150876
  -32704: 37.997439963: 1813773183059
  -32640: 38.241391193: 1784005458543
  -32576: 38.486908639: 1845534899119
  -32512: 38.734002356: 1791192037538
  -32384: 39.232959150: 1802191622859
  -32320: 39.484842662: 1800254890061
  -32256: 39.738343317: 1800244157274
  -32192: 39.993471498: 2018279930645
  -32128: 40.250237653: 2032832901520
  -32064: 40.508652298: 2035876762246
  -32000: 40.768726017: 2038179313630
  -31936: 41.030469463: 2038055317885
  -31872: 41.293893354: 2051743997285
  -31808: 41.559008479: 2051743675052
  -31744: 41.825825697: 2040587572176
  -31680: 42.094355935: 2040269301546
  -31552: 42.636599536: 2034033272043
  -31488: 42.910335106: 2189648036772
  -31424: 43.185828113: 2200128496317
  -31360: 43.463089842: 2526935210436
  -31296: 43.742131646: 2524420427042
  -31232: 44.022964955: 2197502218951
  -31168: 44.305601271: 2065027710327
  -31104: 44.590052169: 1747872268931
  -31040: 44.876329299: 1718138443778
  -30976: 45.164444386: 1720662240442
  -30912: 45.454409229: 2334300189224
  -30848: 45.746235706: 1671556910920
  -30784: 46.039935768: 1661729869479
  -30656: 46.633004838: 1653720048339
  -30592: 46.932398136: 1655232111379
  -30464: 47.536963569: 1655105899948
  -30336: 48.149316786: 1636774266615
  -30272: 48.458445113: 1636732787408
  -30208: 48.769558106: 1636128364324
  -30144: 49.082668507: 1470518420488
  -30080: 49.397789140: 1470518068910
  -29952: 50.034112810: 1045667023841
  -29888: 50.355341907: 1045666891761
  -29824: 50.678633360: 1046082260677
  -29760: 51.004000410: 1028559510000
  -29696: 51.331456381: 1031672196143
  -29632: 51.661014686: 800523246451
  -29440: 52.662439009: 795019089958
  -29312: 53.340816666: 796397036131
  -29120: 54.374803155: 793699894264
  -28864: 55.784697273: 794572511795
  -28800: 56.142846283: 741226341999
  -28736: 56.503294681: 741181712839
  -28608: 57.231148790: 735454424802
  -28544: 57.598584311: 699246942246
  -28480: 57.968378841: 723632049201
  -28416: 58.340547527: 687138055442
  -28352: 58.715105611: 691724401321
  -28288: 59.092068434: 687059991873
  -28224: 59.471451433: 698184106210
  -28096: 60.237540217: 712264071645
  -28032: 60.624277377: 714670233889
  -27776: 62.196215243: 713235255809
  -27712: 62.595527492: 713238511532
  -27648: 62.997403406: 710422157820
  -27392: 64.630874487: 707956716299
  -27328: 65.045817739: 698915101405
  -27200: 65.883713404: 699254771096
  -27136: 66.306700135: 3401420674295
  -27008: 67.160838012: 3406886349494
  -26880: 68.025978570: 3408318035109
  -26816: 68.462719075: 3408760041024
  -26560: 70.237901316: 3444438565500
  -26496: 70.688842811: 3443299005363
  -26432: 71.142679442: 3457679973418
  -26304: 72.059112578: 3458437043869
  -26240: 72.521746618: 3471693986122
  -26176: 72.987350860: 3473782460978
  -26112: 73.455944377: 3488396208595
  -26048: 73.927546358: 3480242371771
  -25984: 74.402176118: 3485747718325
  -25920: 74.879853098: 3499347163546
  -25856: 75.360596860: 3483939886122
  -25728: 76.331363616: 3483182815671
  -25536: 77.811010979: 3518156865649
  -25472: 78.310573366: 3518961423620
  -25344: 79.319340606: 845731107802
  -25280: 79.828586773: 854692539948
  -25216: 80.341102404: 844568780113
  -25152: 80.856908489: 832833240077
  -25088: 81.376026152: 832836028642
  -25024: 81.898476656: 832151487162
  -24960: 82.424281397: 819501775968
  -24896: 82.953461911: 819505541994
  -24832: 83.486039870: 819502753429
  -24768: 84.022037088: 819502777309
  -24704: 84.561475516: 817077433074
  -24640: 85.104377247: 810159923710
  -24512: 86.200659703: 810159972627
  -24448: 86.754085327: 823288695800
  -24384: 87.311064056: 1108130724840
  -24320: 87.871618700: 1134504153829
  -24256: 88.435772218: 1177485097012
  -24192: 89.003547716: 1183039853666
  -24128: 89.574968447: 1186513990999
  -24064: 90.150057814: 1089271253300
  -24000: 90.728839371: 1084488493215
  -23936: 91.311336822: 1123345248022
  -23872: 91.897574024: 1152216372507
  -23808: 92.487574988: 1192690723310
  -23680: 93.678965010: 1178061647022
  -23552: 94.885702068: 1178163396604
  -23424: 96.107983858: 1181079904145
  -23296: 97.346010620: 1152208779660
  -23232: 97.970991645: 1150190122369
  -23168: 98.599985175: 2859806056486
  -23104: 99.233016970: 6177140435554
  -23040: 99.870112957: 6171209253382
  -22976: 100.511299229: 6163566802888
  -22912: 101.156602046: 6113669012857
  -22848: 101.806047837: 6253436459890
  -22720: 103.117474908: 4544348324848
  -22656: 103.779509899: 4528726056906
  -22592: 104.445795287: 4537903735032
  -22528: 105.116358363: 4503065300755
  -22400: 106.470427604: 4502963551173
  -22272: 107.841939454: 4502888588705
  -22016: 110.638192631: 4213879683899
  -21952: 111.348512147: 837550585285
  -21888: 112.063392057: 830196494340
  -21824: 112.782861640: 830049981880
  -21760: 113.506950363: 828705067796
  -21696: 114.235687882: 789848312989
  -21568: 115.707228883: 788782353416
  -21440: 117.197725720: 788277414011
  -21376: 117.950158761: 785605840217
  -21184: 120.236566773: 775668455104
  -20992: 122.567295722: 729384590672
  -20928: 123.354202486: 729289732652
  -20800: 124.943204750: 729234254166
  -20608: 127.365169649: 731653161113
  -20480: 129.005839677: 717814454266
  -20416: 129.834083192: 714339366370
  -20288: 131.506556832: 575494892105
  -20160: 133.200574646: 514675782175
  -20032: 134.916414158: 512289118828
  -19776: 138.414686293: 510907723027
  -19584: 141.097789487: 507250451268
  -19200: 146.621036135: 500353090454
  -18944: 150.422799533: 499825291379
  -18176: 162.429839712: 498485721189
  -18112: 163.472672050: 490530865546
  -18048: 164.522199582: 486305377994
  -17920: 166.641512440: 485387897728
  -17856: 167.711384566: 484553609237
  -17728: 169.871779302: 473900161810
  -16640: 189.395699283: 471481254863
  -16448: 193.067045289: 471447979389
  -16064: 200.624618761: 471693316283
  -13824: 250.992835368: 466235346525
  -12032: 300.249992197: 465990009631
  -10752: 341.247846343: 465645452807
  13440: 3834.092630007: 465643559037
  26240: 13788.967401276: 465662569310
  29248: 18627.775433892: 465768702123
  36800: 39639.100293359: 465643559037
  138112: 995011412.609135811: 465642019029
  443584: 18350384977071360405860.340404819: 0

*/